name: Deploy to Sakura Internet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy files
      env:
        SSHPASS: ${{ secrets.SFTP_PASSWORD }}
      run: |
        # Install sshpass for password authentication
        sudo apt-get update
        sudo apt-get install -y sshpass rsync

        # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        echo "ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­..."
        ls -la *.php *.html *.js *.json *.md 2>/dev/null || true

        # Deploy using rsync with exclusions and verbose logging
        # --checksum: ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã§æ¯”è¼ƒï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã¯ãªãï¼‰
        # -v: è©³ç´°ãƒ­ã‚°
        # --itemize-changes: å¤‰æ›´è©³ç´°ã‚’è¡¨ç¤º
        echo "ğŸš€ rsyncãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."
        sshpass -e rsync -avz --checksum --delete --itemize-changes \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='logs/' \
          --exclude='tests/' \
          --exclude='docs/' \
          --exclude='*.log' \
          --exclude='.env*' \
          --exclude='README.md' \
          --exclude='SETUP.md' \
          --exclude='SECURITY_INCIDENT_REPORT.md' \
          --exclude='*.pem' \
          --exclude='*.key' \
          --exclude='roic/' \
          --exclude='.DS_Store' \
          --exclude='*.tmp' \
          --exclude='*.bak' \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5" \
          ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_REMOTE_PATH }}

        echo "âœ… rsyncã‚³ãƒãƒ³ãƒ‰çµ‚äº† (exit code: $?)"
        
    - name: Deployment notification
      run: |
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://mokumoku.sakura.ne.jp/persona/"